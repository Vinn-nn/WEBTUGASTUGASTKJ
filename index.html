<html lang="en" class="scroll-smooth" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Management App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <div id="app" class="flex-grow flex flex-col max-w-7xl mx-auto p-4 sm:p-6 md:p-8">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-indigo-700">Task Management</h1>
      <div v-if="isLoggedIn" class="flex items-center space-x-4">
        <p class="text-gray-700 font-medium">Hello, <span class="text-indigo-600">{{ currentUser.username }}</span> <span v-if="isAdmin" class="text-sm text-green-600 font-semibold">(Admin)</span></p>
        <button @click="logout" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm flex items-center gap-2">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <!-- Login Form -->
    <section v-if="!isLoggedIn" class="max-w-md w-full mx-auto bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-2xl font-semibold mb-4 text-center text-indigo-700">Login</h2>
      <form @submit.prevent="login" class="space-y-4">
        <div>
          <label for="username" class="block text-gray-700 font-medium mb-1">Username</label>
          <input id="username" v-model="loginForm.username" type="text" autocomplete="username" required
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label for="password" class="block text-gray-700 font-medium mb-1">Password</label>
          <input id="password" v-model="loginForm.password" type="password" autocomplete="current-password" required
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <p v-if="loginError" class="text-red-600 text-sm font-semibold">{{ loginError }}</p>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md flex justify-center items-center gap-2">
          <i class="fas fa-sign-in-alt"></i> Login
        </button>
      </form>
    </section>

    <!-- Main App Content -->
    <section v-if="isLoggedIn" class="flex flex-col md:flex-row gap-6 flex-grow">
      <!-- Task List -->
      <div class="md:w-1/3 bg-white rounded-lg shadow-md p-4 flex flex-col">
        <h2 class="text-xl font-semibold mb-4 text-indigo-700 flex items-center gap-2">
          <i class="fas fa-tasks"></i> Tasks
        </h2>
        <ul class="flex-grow overflow-y-auto divide-y divide-gray-200">
          <li v-for="(task, index) in tasks" :key="task.id" @click="selectTask(index)"
            :class="['cursor-pointer p-3 rounded-md', selectedTaskIndex === index ? 'bg-indigo-100' : 'hover:bg-indigo-50']">
            <h3 class="font-semibold text-gray-800 truncate">{{ task.title }}</h3>
            <p class="text-sm text-gray-600 truncate">{{ task.description }}</p>
            <p class="text-xs text-gray-500 mt-1">Deadline: {{ task.deadline }}</p>
          </li>
          <li v-if="tasks.length === 0" class="text-center text-gray-500 py-6">No tasks available.</li>
        </ul>
      </div>

      <!-- Task Details and Actions -->
      <div class="md:w-2/3 bg-white rounded-lg shadow-md p-6 flex flex-col">
        <div v-if="selectedTaskIndex !== null" class="flex flex-col flex-grow">
          <h2 class="text-2xl font-bold text-indigo-700 mb-3">{{ tasks[selectedTaskIndex].title }}</h2>
          <p class="text-gray-700 mb-4 whitespace-pre-line">{{ tasks[selectedTaskIndex].description }}</p>
          <p class="text-sm text-gray-600 mb-2">Created by: <span class="font-medium">{{ tasks[selectedTaskIndex].created_by }}</span></p>
          <p class="text-sm text-gray-600 mb-2">Created on: <span class="font-medium">{{ tasks[selectedTaskIndex].date }}</span></p>
          <p class="text-sm text-gray-600 mb-4">Deadline: <span class="font-medium">{{ tasks[selectedTaskIndex].deadline }}</span></p>

          <div v-if="tasks[selectedTaskIndex].file_name" class="mb-4">
            <p class="font-semibold text-gray-800 mb-1">Attached File:</p>
            <a :href="tasks[selectedTaskIndex].file_data" :download="tasks[selectedTaskIndex].file_name" target="_blank" rel="noopener noreferrer"
              class="inline-flex items-center gap-2 text-indigo-600 hover:underline">
              <i class="fas fa-file-download"></i> {{ tasks[selectedTaskIndex].file_name }}
            </a>
          </div>

          <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 gap-3 mt-auto">
            <button @click="deleteTask(selectedTaskIndex)" type="button"
              class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-semibold">
              <i class="fas fa-trash-alt"></i> Delete Task
            </button>

            <div class="flex items-center space-x-2">
              <input type="date" v-model="extendDeadlineDate" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
              <button @click="extendDeadline" type="button"
                class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                :disabled="!extendDeadlineDate">
                <i class="fas fa-calendar-plus"></i> Extend Deadline
              </button>
            </div>
          </div>
        </div>

        <div v-else class="flex flex-col justify-center items-center flex-grow text-gray-500 text-center">
          <i class="fas fa-info-circle text-6xl mb-4"></i>
          <p class="text-lg">Select a task from the list to see details and actions.</p>
        </div>
      </div>
    </section>

    <!-- Add New Task Form -->
    <section v-if="isLoggedIn" class="mt-8 max-w-3xl w-full bg-white rounded-lg shadow-md p-6 mx-auto">
      <h2 class="text-2xl font-semibold mb-5 text-indigo-700 flex items-center gap-2">
        <i class="fas fa-plus-circle"></i> Add New Task
      </h2>
      <form @submit.prevent="addTask" class="space-y-5">
        <div>
          <label for="title" class="block text-gray-700 font-medium mb-1">Title</label>
          <input id="title" v-model="newTask.title" type="text" required
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label for="description" class="block text-gray-700 font-medium mb-1">Description</label>
          <textarea id="description" v-model="newTask.description" rows="4" required
            class="w-full border border-gray-300 rounded-md px-3 py-2 resize-y focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <div>
          <label for="deadline" class="block text-gray-700 font-medium mb-1">Deadline</label>
          <input id="deadline" v-model="newTask.deadline" type="date" required
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label for="file" class="block text-gray-700 font-medium mb-1">Attach File (optional)</label>
          <input id="file" type="file" @change="handleFileUpload"
            class="w-full text-gray-700" />
          <p v-if="newTask.fileName" class="mt-1 text-sm text-gray-600">Selected file: <span class="font-medium">{{ newTask.fileName }}</span></p>
        </div>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-md flex justify-center items-center gap-2">
          <i class="fas fa-plus"></i> Add Task
        </button>
      </form>
    </section>
  </div>

  <script>
    const { createApp, reactive, ref, computed } = Vue;

    const SUPABASE_URL = 'https://ejawjpkjqmlyjzbqlpgt.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYXdqcGtqcW1seWp6YnFscGd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjE5MzgsImV4cCI6MjA3MjA5NzkzOH0.9QEE4t2QYdnZpwcEuVpAdKTis74gLNv8SVOdP5AvvNU
'; 
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    createApp({
      setup() {
        // Reactive state
        const loginForm = reactive({
          username: '',
          password: '',
        });

        const loginError = ref('');
        const isLoggedIn = ref(false);
        const currentUser = reactive({ username: '', role: '' });

        const tasks = ref([]);
        const selectedTaskIndex = ref(null);

        const newTask = reactive({
          title: '',
          description: '',
          deadline: '',
          fileName: '',
          fileData: '',
        });

        const extendDeadlineDate = ref('');
        const selectedMemberToPromote = ref('');

        const isAdmin = computed(() => currentUser.role === 'admin');

        // Load tasks from Supabase
        async function loadTasks() {
          if (!isLoggedIn.value) return;
          const { data, error } = await supabase
            .from('tasks')
            .select('*')
            .order('date_created', { ascending: true });
          if (error) {
            console.error('Error loading tasks:', error);
            return;
          }
          tasks.value = data.map(task => ({
            ...task,
            // Format dates to Indonesian locale for display
            date: new Date(task.date_created).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }),
            deadline: new Date(task.deadline).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }),
          }));
          selectedTaskIndex.value = null;
          extendDeadlineDate.value = '';
        }

        // Login function
        async function login() {
          loginError.value = '';
          const usernameInput = loginForm.username.trim();
          const passwordInput = loginForm.password;

          // Query user from Supabase
          const { data, error } = await supabase
            .from('users')
            .select('username, password, role')
            .eq('username', usernameInput)
            .limit(1)
            .single();

          if (error || !data) {
            loginError.value = 'Username atau password salah.';
            return;
          }

          if (data.password !== passwordInput) {
            loginError.value = 'Username atau password salah.';
            return;
          }

          currentUser.username = data.username;
          currentUser.role = data.role;
          isLoggedIn.value = true;

          loginForm.username = '';
          loginForm.password = '';

          await loadTasks();
        }

        // Logout
        function logout() {
          isLoggedIn.value = false;
          currentUser.username = '';
          currentUser.role = '';
          tasks.value = [];
          selectedTaskIndex.value = null;
          loginError.value = '';
          newTask.title = '';
          newTask.description = '';
          newTask.deadline = '';
          newTask.fileName = '';
          newTask.fileData = '';
          selectedMemberToPromote.value = '';
          extendDeadlineDate.value = '';
        }

        // Add task
        async function addTask() {
          if (!newTask.title.trim() || !newTask.description.trim() || !newTask.deadline) return;

          const { data, error } = await supabase.from('tasks').insert([{
            title: newTask.title.trim(),
            description: newTask.description.trim(),
            created_by: currentUser.username,
            date_created: new Date().toISOString(),
            deadline: newTask.deadline,
            file_name: newTask.fileName,
            file_data: newTask.fileData,
          }]);

          if (error) {
            alert('Gagal menambahkan tugas: ' + error.message);
            return;
          }

          // Reload tasks
          await loadTasks();

          // Reset form
          newTask.title = '';
          newTask.description = '';
          newTask.deadline = '';
          newTask.fileName = '';
          newTask.fileData = '';

          // Pilih tugas terakhir
          selectedTaskIndex.value = tasks.value.length - 1;

          // Reset file input manually
          const fileInput = document.getElementById('file');
          if (fileInput) fileInput.value = '';
        }

        // Delete task
        async function deleteTask(index) {
          if (index === null || index < 0 || index >= tasks.value.length) return;
          const taskId = tasks.value[index].id;

          const { error } = await supabase.from('tasks').delete().eq('id', taskId);
          if (error) {
            alert('Gagal menghapus tugas: ' + error.message);
            return;
          }

          await loadTasks();
          selectedTaskIndex.value = null;
          extendDeadlineDate.value = '';
        }

        // Select task
        function selectTask(index) {
          selectedTaskIndex.value = index;
          extendDeadlineDate.value = '';
        }

        // Extend deadline
        async function extendDeadline() {
          if (selectedTaskIndex.value === null) return;
          if (!extendDeadlineDate.value) return;

          const task = tasks.value[selectedTaskIndex.value];
          const newDate = new Date(extendDeadlineDate.value);
          if (isNaN(newDate.getTime())) {
            alert('Tanggal perpanjangan tidak valid.');
            return;
          }

          const { error } = await supabase
            .from('tasks')
            .update({ deadline: extendDeadlineDate.value })
            .eq('id', task.id);

          if (error) {
            alert('Gagal memperpanjang deadline: ' + error.message);
            return;
          }

          await loadTasks();
          alert('Deadline berhasil diperpanjang.');
          extendDeadlineDate.value = '';
        }

        // Handle file upload
        function handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) {
            newTask.fileName = '';
            newTask.fileData = '';
            return;
          }
          newTask.fileName = file.name;

          const reader = new FileReader();
          reader.onload = (e) => {
            newTask.fileData = e.target.result;
          };
          reader.readAsDataURL(file);
        }

        return {
          loginForm,
          loginError,
          isLoggedIn,
          currentUser,
          tasks,
          selectedTaskIndex,
          newTask,
          isAdmin,
          selectedMemberToPromote,
          extendDeadlineDate,
          login,
          logout,
          addTask,
          deleteTask,
          selectTask,
          extendDeadline,
          handleFileUpload,
        };
      },
    }).mount('#app');
  </script>
</body>
</html>
